# Security Review - 2025-12-19

## Overview
A comprehensive security review of the codebase was performed on December 19, 2025. The review focused on common web vulnerabilities including CSRF, XSS, SSRF, SQL Injection, and Insecure Direct Object References (IDOR).

## Findings

### 1. Cross-Site Request Forgery (CSRF) - **CRITICAL**
**Issue:** The application lacked CSRF protection on POST forms. This could allow attackers to perform actions on behalf of authenticated administrators if they visited a malicious site.
**Status:** **PATCHED**
**Action Taken:**
- Added `Flask-WTF` to dependencies.
- Initialized `CSRFProtect` in `main.py`.
- Configured CSRF protection to be active by default but manually handled in `before_request` to exempt legitimate API Key requests.
- Added CSRF token hidden inputs to all forms in:
    - `templates/settings.html`
    - `templates/service_form.html`
    - `templates/onboarding.html`
- Added `<meta name="csrf-token">` to `base.html` for future JavaScript `fetch` usage.

### 2. Cross-Site Scripting (XSS) - **HIGH**
**Issue:** The `showToast` function in `templates/base.html` and `templates/login.html` used `innerHTML` to render messages. If a malicious script was injected into a service name or error message, it could execute in the context of the user's browser.
**Status:** **PATCHED**
**Action Taken:**
- Updated `showToast` logic to use `textContent` for the message body, preventing HTML interpretation of dynamic content.

### 3. Server-Side Request Forgery (SSRF) - **MEDIUM**
**Issue:** The `check_service_health` function performs HTTP requests to user-defined `target_url`s. While the application is designed to access internal services, unrestricted protocol usage could allow interaction with local files or other protocols.
**Status:** **PARTIALLY MITIGATED**
**Action Taken:**
- Added strict validation in `new_service` and `edit_service` routes in `main.py` to ensure `target_url` must start with `http://` or `https://`.

### 4. SSL Verification - **LOW**
**Issue:** `requests.get(..., verify=False)` is used frequently.
**Status:** **ACCEPTED RISK**
**Reasoning:** This application is designed for home lab environments where self-signed certificates are common (e.g., UniFi Controllers, local web apps). Enforcing SSL verification would break functionality for many users.
**Recommendation:** Document this behavior and potentially add a setting to toggle verification in the future.

### 5. SQL Injection - **SAFE**
**Status:** **PASS**
**Reasoning:** `database.py` consistently uses parameterized queries (`?` placeholder) with `sqlite3`, effectively preventing SQL injection attacks.

## Recommendations
1.  **Re-build Container:** Users must rebuild their Docker containers to install the new `Flask-WTF` dependency.
2.  **API Key Scope:** Future updates should consider adding granular scopes to API keys.
3.  **Content Security Policy (CSP):** Implement a CSP header to further mitigate XSS risks.
