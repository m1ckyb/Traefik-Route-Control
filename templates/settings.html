{% extends "base.html" %}

{% block title %}Settings - Traefik Route Control{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Settings</h2>
    
    <form method="POST" class="settings-form">
        <div class="settings-tabs">
            <button type="button" class="tab-btn" onclick="openTab(event, 'tab-general')">General</button>
            <button type="button" class="tab-btn active" onclick="openTab(event, 'tab-security')">Security</button>
            <button type="button" class="tab-btn" onclick="openTab(event, 'tab-monitoring')">Monitoring</button>
            <button type="button" class="tab-btn" onclick="openTab(event, 'tab-infrastructure')">Infrastructure</button>
            <button type="button" class="tab-btn" onclick="openTab(event, 'tab-integrations')">Integrations</button>
        </div>

        <!-- Tab: General -->
        <div id="tab-general" class="tab-content" style="display: none;">
            <h3>Appearance</h3>
            <div class="form-group">
                <label for="dark_mode_toggle">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark_mode_toggle" onchange="window.toggleTheme(this.checked)">
                    <span class="slider round"></span>
                </label>
                <p class="help-text" style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">Toggle dark mode theme (persists across sessions)</p>
            </div>

            <h3>Backup & Restore</h3>
            <div class="form-group">
                <label>Backup Configuration</label>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/api/settings/backup'">‚¨áÔ∏è Download Settings Backup</button>
                <p class="help-text" style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">Download all current settings as a JSON file.</p>
            </div>

            <div class="form-group">
                <label>Restore Configuration</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="restore_file" accept=".json" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="restoreSettings()">‚¨ÜÔ∏è Restore</button>
                </div>
                <p class="help-text" style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">Upload a previously backed up JSON file to restore settings.</p>
            </div>
        </div>

        <!-- Tab: Security -->
        <div id="tab-security" class="tab-content" style="display: block;">
        <div class="form-group" style="background: var(--bg-card); padding: 1rem; border: 1px solid var(--border); border-radius: 4px; display: none;">
            <label for="ENFORCE_2FA" style="font-weight: bold; color: var(--primary);">üõ°Ô∏è Enforce 2FA Globally</label>
            <select id="ENFORCE_2FA" name="ENFORCE_2FA">
                <option value="0" {% if settings.get('ENFORCE_2FA', '0') == '0' %}selected{% endif %}>Disabled (Optional)</option>
                <option value="1" {% if settings.get('ENFORCE_2FA', '0') == '1' %}selected{% endif %}>Enabled (Mandatory)</option>
            </select>
            <p class="help-text" style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">If enabled, all users will be forced to set up 2FA to access the dashboard.</p>
        </div>

        <h3>Security Settings</h3>
        
        <div class="security-section">
            <div class="form-group">
                <label>Password</label>
                <div class="password-actions">
                    {% if has_password %}
                        <p class="status-text">‚úÖ Password is set</p>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="togglePasswordForm()">Change Password</button>
                    {% else %}
                        <p class="status-text warning">‚ö†Ô∏è No password set</p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="togglePasswordForm()">Set Password</button>
                    {% endif %}
                </div>
                
                <div id="password-form" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 4px;">
                    <div class="form-group">
                        <label for="new_password">New Password (min 8 chars)</label>
                        <input type="password" id="new_password" placeholder="Enter new password">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="savePassword()">Save Password</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Passkeys</label>
                <ul class="passkey-list">
                    {% for cred in credentials %}
                    <li>üîë Passkey added on {{ cred.created_at }}</li>
                    {% endfor %}
                </ul>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addPasskey()">‚ûï Add New Passkey</button>
            </div>

            <div class="form-group">
                <label>Two-Factor Authentication (2FA)</label>
                <div class="2fa-actions">
                    {% if has_2fa %}
                        <p class="status-text">‚úÖ 2FA is enabled</p>
                        <button type="button" class="btn btn-danger btn-sm" onclick="disable2FA()">Disable 2FA</button>
                    {% else %}
                        <p class="status-text warning">‚ö†Ô∏è 2FA is not enabled</p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="setup2FA()">Setup 2FA</button>
                    {% endif %}
                </div>
                
                <div id="2fa-setup" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 4px; text-align: center;">
                    <p>Scan this QR code with your authenticator app:</p>
                    <img id="qr-code-img" src="" alt="QR Code" style="background: white; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <div style="margin: 10px 0;">
                        <p style="font-size: 0.9em; color: var(--text-dim); margin-bottom: 5px;">Or enter code manually:</p>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                            <code id="totp-secret-display" style="background: var(--bg-card); padding: 5px 10px; border-radius: 4px; font-family: monospace; font-weight: bold;"></code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyTotpSecret()">üìã Copy</button>
                        </div>
                    </div>
                    <p>Then enter the 6-digit code below:</p>
                    <input type="text" id="setup_totp_code" placeholder="123456" style="width: 150px; text-align: center; margin-bottom: 10px;">
                    <button type="button" class="btn btn-primary btn-block" onclick="verifySetup2FA()">Verify & Enable</button>
                </div>
            </div>

            <div class="form-group">
                <label>Recovery Codes</label>
                <div class="recovery-actions">
                    <p class="status-text">
                        {% if recovery_codes_count > 0 %}
                        ‚úÖ {{ recovery_codes_count }} unused codes remaining
                        {% else %}
                        ‚ö†Ô∏è No recovery codes generated
                        {% endif %}
                    </p>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="generateRecoveryCodes()">üîÑ Generate New Codes</button>
                </div>
                <div id="recovery-codes-display" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 4px;">
                    <p class="warning" style="margin-bottom: 0.5rem;">‚ö†Ô∏è Save these codes somewhere safe. They will not be shown again.</p>
                    <div id="codes-list" style="font-family: monospace; font-size: 1.1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"></div>
                </div>
            </div>
        </div>
        </div>

        <!-- Tab: Monitoring -->
        <div id="tab-monitoring" class="tab-content" style="display: none;">
        <h3>Health Check</h3>
        
        <div class="form-group">
            <label for="HEALTH_CHECK_INTERVAL">Check Interval (seconds) <span class="tooltip-icon" data-tooltip="How often to check service health in the background (min 10s)">‚ÑπÔ∏è</span></label>
            <input type="number" id="HEALTH_CHECK_INTERVAL" name="HEALTH_CHECK_INTERVAL" required 
                   value="{{ settings.get('HEALTH_CHECK_INTERVAL', '60') }}" min="10">
        </div>
        
        <div class="form-group">
            <label for="HEALTH_CHECK_TIMEOUT">Request Timeout (seconds) <span class="tooltip-icon" data-tooltip="Maximum time to wait for a service to respond">‚ÑπÔ∏è</span></label>
            <input type="number" id="HEALTH_CHECK_TIMEOUT" name="HEALTH_CHECK_TIMEOUT" required 
                   value="{{ settings.get('HEALTH_CHECK_TIMEOUT', '1') }}" min="1" max="30">
        </div>

        <h3>Notifications</h3>
        
        <div class="form-group">
            <label for="NOTIFY_EVENTS_HEALTH">Health Alerts <span class="tooltip-icon" data-tooltip="Notify when services become unhealthy or recover">‚ÑπÔ∏è</span></label>
            <select id="NOTIFY_EVENTS_HEALTH" name="NOTIFY_EVENTS_HEALTH">
                <option value="1" {% if settings.get('NOTIFY_EVENTS_HEALTH', '1') == '1' %}selected{% endif %}>Enabled</option>
                <option value="0" {% if settings.get('NOTIFY_EVENTS_HEALTH', '1') == '0' %}selected{% endif %}>Disabled</option>
            </select>
        </div>

        <div class="form-group">
            <label for="NOTIFY_EVENTS_SYSTEM">System Events <span class="tooltip-icon" data-tooltip="Notify about system events (e.g. startup, shutdown)">‚ÑπÔ∏è</span></label>
            <select id="NOTIFY_EVENTS_SYSTEM" name="NOTIFY_EVENTS_SYSTEM">
                <option value="1" {% if settings.get('NOTIFY_EVENTS_SYSTEM', '1') == '1' %}selected{% endif %}>Enabled</option>
                <option value="0" {% if settings.get('NOTIFY_EVENTS_SYSTEM', '1') == '0' %}selected{% endif %}>Disabled</option>
            </select>
        </div>

        <div class="form-group">
            <label for="DISCORD_WEBHOOK_URL">Discord Webhook URL <span class="tooltip-icon" data-tooltip="Leave empty to disable notifications">‚ÑπÔ∏è</span></label>
            <input type="url" id="DISCORD_WEBHOOK_URL" name="DISCORD_WEBHOOK_URL" 
                   value="{{ settings.get('DISCORD_WEBHOOK_URL', '') }}"
                   placeholder="https://discord.com/api/webhooks/...">
        </div>
        <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="testDiscordWebhook(event)">üîî Test Notification</button>
        </div>
        </div>

        <!-- Tab: Infrastructure -->
        <div id="tab-infrastructure" class="tab-content" style="display: none;">
        <h3>Cloudflare</h3>
        
        <div class="form-group">
            <label for="CF_API_TOKEN">Cloudflare API Token <span class="tooltip-icon" data-tooltip="Token with Zone:DNS:Edit permissions">‚ÑπÔ∏è</span></label>
            <input type="password" id="CF_API_TOKEN" name="CF_API_TOKEN" required 
                   value="{{ settings.get('CF_API_TOKEN', '') }}" autocomplete="off">
        </div>
        
        <div class="form-group">
            <label for="CF_ZONE_ID">Cloudflare Zone ID <span class="tooltip-icon" data-tooltip="The Zone ID for your domain from Cloudflare dashboard">‚ÑπÔ∏è</span></label>
            <input type="text" id="CF_ZONE_ID" name="CF_ZONE_ID" required 
                   value="{{ settings.get('CF_ZONE_ID', '') }}">
        </div>
        
        <div class="form-group">
            <label for="DOMAIN_ROOT">Domain Root <span class="tooltip-icon" data-tooltip="Your main domain (e.g., example.com)">‚ÑπÔ∏è</span></label>
            <input type="text" id="DOMAIN_ROOT" name="DOMAIN_ROOT" required 
                   value="{{ settings.get('DOMAIN_ROOT', '') }}"
                   pattern="^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$"
                   title="Please enter a valid domain name (e.g., example.com)"
                   placeholder="example.com">
        </div>
        
        <div class="form-group">
            <label for="ORIGIN_RULE_NAME">Origin Rule Name <span class="tooltip-icon" data-tooltip="Name of the Cloudflare Origin Rule to manage">‚ÑπÔ∏è</span></label>
            <input type="text" id="ORIGIN_RULE_NAME" name="ORIGIN_RULE_NAME" required 
                   value="{{ settings.get('ORIGIN_RULE_NAME', '') }}"
                   placeholder="Service Rotation">
        </div>
        <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="testCloudflareConnection(event)">‚òÅÔ∏è Test Cloudflare Connection</button>
        </div>
        
        <h3>Traefik / Redis</h3>
        
        <div class="form-group">
            <label for="REDIS_HOST">Redis Host <span class="tooltip-icon" data-tooltip="Hostname or IP of the Redis server">‚ÑπÔ∏è</span></label>
            <input type="text" id="REDIS_HOST" name="REDIS_HOST" required 
                   value="{{ settings.get('REDIS_HOST', '') }}"
                   placeholder="127.0.0.1">
        </div>
        
        <div class="form-group">
            <label for="REDIS_PORT">Redis Port <span class="tooltip-icon" data-tooltip="Port of the Redis server (default 6379)">‚ÑπÔ∏è</span></label>
            <input type="number" id="REDIS_PORT" name="REDIS_PORT" required 
                   value="{{ settings.get('REDIS_PORT', '6379') }}">
        </div>
        
        <div class="form-group">
            <label for="REDIS_PASS">Redis Password (optional) <span class="tooltip-icon" data-tooltip="Password if Redis authentication is enabled">‚ÑπÔ∏è</span></label>
            <input type="password" id="REDIS_PASS" name="REDIS_PASS" 
                   value="{{ settings.get('REDIS_PASS', '') }}" autocomplete="off">
        </div>
        <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="testRedisConnection(event)">üîå Test Redis Connection</button>
        </div>
        </div>
        
        <!-- Tab: Integrations -->
        <div id="tab-integrations" class="tab-content" style="display: none;">
        <h3>Home Assistant</h3>
        
        <div class="form-group">
            <label for="HASS_ENABLED">Enable Home Assistant Integration <span class="tooltip-icon" data-tooltip="Update Home Assistant entities with service status">‚ÑπÔ∏è</span></label>
            <select id="HASS_ENABLED" name="HASS_ENABLED" onchange="toggleHomeAssistantSettings()">
                <option value="0" {% if settings.get('HASS_ENABLED', '0') == '0' %}selected{% endif %}>Disabled</option>
                <option value="1" {% if settings.get('HASS_ENABLED', '0') == '1' %}selected{% endif %}>Enabled</option>
            </select>
        </div>
        
        <div id="hass-settings" style="{% if settings.get('HASS_ENABLED', '1') == '0' %}display: none;{% else %}display: grid;{% endif %}">
            <div class="form-group">
                <label for="HASS_URL">Home Assistant URL <span class="tooltip-icon" data-tooltip="URL of your Home Assistant instance">‚ÑπÔ∏è</span></label>
                <input type="url" id="HASS_URL" name="HASS_URL" 
                       value="{{ settings.get('HASS_URL', '') }}"
                       placeholder="http://homeassistant.local:8123">
            </div>
            
            <div class="form-group">
                <label for="HASS_TOKEN">Home Assistant Token <span class="tooltip-icon" data-tooltip="Long-Lived Access Token from Home Assistant">‚ÑπÔ∏è</span></label>
                <input type="password" id="HASS_TOKEN" name="HASS_TOKEN" 
                       value="{{ settings.get('HASS_TOKEN', '') }}" autocomplete="off">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-secondary" onclick="testHassConnection(event)">üîå Test HA Connection</button>
            </div>
        </div>
        
        <h3>Firewall</h3>
        
        <div class="form-group">
            <label for="FIREWALL_TYPE">Firewall Controller Type <span class="tooltip-icon" data-tooltip="System used to manage firewall rules">‚ÑπÔ∏è</span></label>
            <select id="FIREWALL_TYPE" name="FIREWALL_TYPE" onchange="toggleFirewallSettings()">
                <option value="none" {% if settings.get('FIREWALL_TYPE', 'unifi') == 'none' %}selected{% endif %}>None</option>
                <option value="unifi" {% if settings.get('FIREWALL_TYPE', 'unifi') == 'unifi' %}selected{% endif %}>UniFi</option>
            </select>
        </div>
        
        <div id="unifi-settings" style="{% if settings.get('FIREWALL_TYPE', 'unifi') == 'none' %}display: none;{% else %}display: grid;{% endif %}">
            <div class="form-group">
                <label for="UNIFI_HOST">UniFi Host <span class="tooltip-icon" data-tooltip="IP address or hostname of UniFi Controller/Console">‚ÑπÔ∏è</span></label>
                <input type="text" id="UNIFI_HOST" name="UNIFI_HOST" 
                       value="{{ settings.get('UNIFI_HOST', '') }}"
                       placeholder="192.168.1.1">
            </div>
            
            <div class="form-group">
                <label for="UNIFI_USER">UniFi Username <span class="tooltip-icon" data-tooltip="Local admin username for UniFi">‚ÑπÔ∏è</span></label>
                <input type="text" id="UNIFI_USER" name="UNIFI_USER" 
                       value="{{ settings.get('UNIFI_USER', '') }}">
            </div>
            
            <div class="form-group">
                <label for="UNIFI_PASS">UniFi Password <span class="tooltip-icon" data-tooltip="Local admin password for UniFi">‚ÑπÔ∏è</span></label>
                <input type="password" id="UNIFI_PASS" name="UNIFI_PASS" 
                       value="{{ settings.get('UNIFI_PASS', '') }}" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label for="UNIFI_RULE_NAME">UniFi Port Forward Rule Name <span class="tooltip-icon" data-tooltip="Name of the Port Forward rule to toggle">‚ÑπÔ∏è</span></label>
                <input type="text" id="UNIFI_RULE_NAME" name="UNIFI_RULE_NAME" 
                       value="{{ settings.get('UNIFI_RULE_NAME', '') }}"
                       placeholder="External">
            </div>

            <div class="form-group">
                <label for="UNIFI_IP_GROUP_NAME">Allowed IPs List (Address Group) <span class="tooltip-icon" data-tooltip="UniFi Address Group to sync active service IPs to">‚ÑπÔ∏è</span></label>
                <input type="text" id="UNIFI_IP_GROUP_NAME" name="UNIFI_IP_GROUP_NAME" 
                       value="{{ settings.get('UNIFI_IP_GROUP_NAME', '') }}"
                       placeholder="VLAN 50 Allowed IPs">
            </div>

            <div class="form-group">
                <label for="UNIFI_PORT_GROUP_NAME">Allowed Ports List (Port Group) <span class="tooltip-icon" data-tooltip="UniFi Port Group to sync active service ports to">‚ÑπÔ∏è</span></label>
                <input type="text" id="UNIFI_PORT_GROUP_NAME" name="UNIFI_PORT_GROUP_NAME" 
                       value="{{ settings.get('UNIFI_PORT_GROUP_NAME', '') }}"
                       placeholder="VLAN 50 Allowed Ports">
            </div>

            <div class="form-group">
                <label for="TRAEFIK_LAN_CIDR">Traefik LAN CIDR (Excluded from IP List) <span class="tooltip-icon" data-tooltip="Subnet to exclude from IP group (e.g. if Traefik is local)">‚ÑπÔ∏è</span></label>
                <input type="text" id="TRAEFIK_LAN_CIDR" name="TRAEFIK_LAN_CIDR" 
                       value="{{ settings.get('TRAEFIK_LAN_CIDR', '') }}"
                       pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(/(3[0-2]|[12]?[0-9]))?$"
                       title="Please enter a valid IPv4 address or CIDR (e.g. 192.168.1.1 or 192.168.1.0/24)"
                       placeholder="192.168.50.0/24">
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-secondary" onclick="syncFirewall()">üîÑ Sync Firewall Groups Now</button>
            </div>
        </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
            <a href="/" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// WebAuthn Helpers
function arrayBufferToBase64(buffer) {
    const binary = Array.from(new Uint8Array(buffer), byte => String.fromCharCode(byte)).join('');
    return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function base64ToArrayBuffer(base64) {
    let standardBase64 = base64.replace(/-/g, '+').replace(/_/g, '/');
    while (standardBase64.length % 4 !== 0) standardBase64 += '=';
    const binary = atob(standardBase64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
}

function togglePasswordForm() {
    const form = document.getElementById('password-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function savePassword() {
    const password = document.getElementById('new_password').value;
    if (password.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
    }
    
    try {
        const response = await fetch('/auth/password/change', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: password})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('Password updated successfully');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Error updating password: ' + e.message);
    }
}

async function addPasskey() {
    try {
        // 1. Get options
        const optionsResponse = await fetch('/auth/passkey/add/begin', {
            method: 'POST'
        });
        
        if (!optionsResponse.ok) throw new Error('Failed to start registration');
        const options = await optionsResponse.json();
        
        // 2. Convert buffers
        options.challenge = base64ToArrayBuffer(options.challenge);
        options.user.id = base64ToArrayBuffer(options.user.id);
        if (options.excludeCredentials) {
            options.excludeCredentials = options.excludeCredentials.map(c => ({
                ...c,
                id: base64ToArrayBuffer(c.id)
            }));
        }
        
        // 3. Create credential
        const credential = await navigator.credentials.create({
            publicKey: options
        });
        
        // 4. Prepare response
        const credentialData = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            response: {
                attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
            },
            type: credential.type
        };
        
        // 5. Send to server
        const verifyResponse = await fetch('/auth/passkey/add/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({credential: credentialData})
        });
        
        const result = await verifyResponse.json();
        if (verifyResponse.ok) {
            alert('Passkey added successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        console.error(e);
        alert('Failed to add passkey: ' + e.message);
    }
}

async function setup2FA() {
    try {
        const response = await fetch('/auth/2fa/setup/begin', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('qr-code-img').src = data.qr_code;
            document.getElementById('totp-secret-display').textContent = data.secret;
            document.getElementById('2fa-setup').style.display = 'block';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Failed to start 2FA setup: ' + e.message);
    }
}

function copyTotpSecret() {
    const secret = document.getElementById('totp-secret-display').textContent;
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(secret).then(() => {
            alert('Secret copied to clipboard!');
        });
    } else {
        prompt("Copy this code:", secret);
    }
}

async function verifySetup2FA() {
    const code = document.getElementById('setup_totp_code').value;
    if (!code) return;
    
    try {
        const response = await fetch('/auth/2fa/setup/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code: code})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('2FA Enabled Successfully!');
            location.reload();
        } else {
            alert('Verification failed: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function disable2FA() {
    if (!confirm('Are you sure you want to disable 2FA? This will reduce your account security.')) return;
    
    try {
        const response = await fetch('/auth/2fa/disable', { method: 'POST' });
        if (response.ok) {
            location.reload();
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function generateRecoveryCodes() {
    if (!confirm('Generating new codes will invalidate any existing recovery codes. Continue?')) return;
    
    try {
        const response = await fetch('/auth/2fa/recovery-codes/generate', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            const list = document.getElementById('codes-list');
            list.innerHTML = '';
            data.codes.forEach(code => {
                const el = document.createElement('div');
                el.textContent = code;
                list.appendChild(el);
            });
            document.getElementById('recovery-codes-display').style.display = 'block';
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function testDiscordWebhook(event) {
    const url = document.getElementById('DISCORD_WEBHOOK_URL').value;
    if (!url) {
        alert('Please enter a Webhook URL first');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Sending...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/notifications/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({webhook_url: url})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('Test notification sent successfully!');
        } else {
            alert('Error: ' + (data.error || 'Failed to send notification'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function testRedisConnection(event) {
    const host = document.getElementById('REDIS_HOST').value;
    const port = document.getElementById('REDIS_PORT').value;
    const pass = document.getElementById('REDIS_PASS').value;
    
    if (!host || !port) {
        alert('Please enter Redis Host and Port');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Testing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/test/redis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({host: host, port: port, password: pass})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('‚úÖ ' + data.message);
        } else {
            alert('‚ùå ' + (data.error || 'Connection failed'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function testHassConnection(event) {
    const url = document.getElementById('HASS_URL').value;
    const token = document.getElementById('HASS_TOKEN').value;
    
    if (!url || !token) {
        alert('Please enter Home Assistant URL and Token');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Testing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/test/hass', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url, token: token})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('‚úÖ ' + data.message);
        } else {
            alert('‚ùå ' + (data.error || 'Connection failed'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function testCloudflareConnection(event) {
    const token = document.getElementById('CF_API_TOKEN').value;
    const zoneId = document.getElementById('CF_ZONE_ID').value;
    
    if (!token || !zoneId) {
        alert('Please enter Cloudflare API Token and Zone ID');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Testing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/test/cloudflare', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token, zone_id: zoneId})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('‚úÖ ' + data.message);
        } else {
            alert('‚ùå ' + (data.error || 'Connection failed'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function restoreSettings() {
    const fileInput = document.getElementById('restore_file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a backup file first.');
        return;
    }
    
    if (!confirm('Are you sure you want to restore settings? This will overwrite current configuration.')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/settings/restore', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ ' + data.message);
            window.location.reload();
        } else {
            alert('‚ùå ' + (data.error || 'Restore failed'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function toggleHomeAssistantSettings() {
    const enabled = document.getElementById('HASS_ENABLED').value === '1';
    const hassSettings = document.getElementById('hass-settings');
    
    if (enabled) {
        hassSettings.style.display = 'grid';
    } else {
        hassSettings.style.display = 'none';
    }
}

function toggleFirewallSettings() {
    const type = document.getElementById('FIREWALL_TYPE').value;
    const unifiSettings = document.getElementById('unifi-settings');
    
    if (type === 'unifi') {
        unifiSettings.style.display = 'grid';
    } else {
        unifiSettings.style.display = 'none';
    }
}

function syncFirewall() {
    if(confirm('Force sync UniFi firewall groups?')) {
        fetch('/api/sync-firewall', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if(data.error) alert('Error: ' + data.error);
                else alert('Sync triggered. Check logs for details.');
            });
    }
}

function openTab(evt, tabName) {
    // Hide all tab content
    const tabContents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].style.display = "none";
    }

    // Remove active class from all buttons
    const tabBtns = document.getElementsByClassName("tab-btn");
    for (let i = 0; i < tabBtns.length; i++) {
        tabBtns[i].classList.remove("active");
    }

    // Show current tab and activate button
    document.getElementById(tabName).style.display = "block";
    if (evt) {
        evt.currentTarget.classList.add("active");
    } else {
        // Find button for this tab if called programmatically
        const btn = document.querySelector(`.tab-btn[onclick*="${tabName}"]`);
        if (btn) btn.classList.add("active");
    }
    
    // Save state
    localStorage.setItem('activeSettingsTab', tabName);
}

// Initialize tabs
document.addEventListener('DOMContentLoaded', function() {
    const activeTab = localStorage.getItem('activeSettingsTab') || 'tab-security';
    openTab(null, activeTab);
    
    // Initialize Dark Mode Toggle
    const darkModeToggle = document.getElementById('dark_mode_toggle');
    if (darkModeToggle) {
        darkModeToggle.checked = document.documentElement.classList.contains('dark-mode');
    }
});
</script>

<style>
.security-section {
    background: var(--bg-card);
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 2rem;
    grid-column: span 2;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.settings-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 2rem;
    gap: 1rem;
    overflow-x: auto;
    grid-column: 1 / -1;
}

.tab-btn {
    background: none;
    border: none;
    padding: 0.75rem 1rem;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
}

.tab-btn:hover {
    color: var(--text);
}

.tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content {
    animation: fadeIn 0.3s ease;
    grid-column: 1 / -1;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Tooltips */
.tooltip-icon {
    display: inline-block;
    margin-left: 0.5rem;
    cursor: help;
    color: var(--text-dim);
    position: relative;
}

.tooltip-icon:hover {
    color: var(--primary);
}

.tooltip-icon[data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    white-space: normal;
    width: max-content;
    max-width: 250px;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 100;
    pointer-events: none;
    margin-bottom: 8px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    font-weight: normal;
}

.tooltip-icon[data-tooltip]:hover::after {
    visibility: visible;
    opacity: 1;
}
</style>
{% endblock %}
