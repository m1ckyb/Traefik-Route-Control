{% extends "base.html" %}

{% block title %}Settings - Traefik Route Control{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Global Settings</h2>
    
    <form method="POST" class="settings-form">
        <div class="form-group" style="background: var(--bg-card); padding: 1rem; border: 1px solid var(--border); border-radius: 4px;">
            <label for="ENFORCE_2FA" style="font-weight: bold; color: var(--primary);">üõ°Ô∏è Enforce 2FA Globally</label>
            <select id="ENFORCE_2FA" name="ENFORCE_2FA">
                <option value="0" {% if settings.get('ENFORCE_2FA', '0') == '0' %}selected{% endif %}>Disabled (Optional)</option>
                <option value="1" {% if settings.get('ENFORCE_2FA', '0') == '1' %}selected{% endif %}>Enabled (Mandatory)</option>
            </select>
            <p class="help-text" style="font-size: 0.85rem; color: var(--text-dim); margin-top: 0.5rem;">If enabled, all users will be forced to set up 2FA to access the dashboard.</p>
        </div>

        <h3>Security</h3>
        
        <div class="security-section">
            <div class="form-group">
                <label>Password</label>
                <div class="password-actions">
                    {% if has_password %}
                        <p class="status-text">‚úÖ Password is set</p>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="togglePasswordForm()">Change Password</button>
                    {% else %}
                        <p class="status-text warning">‚ö†Ô∏è No password set</p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="togglePasswordForm()">Set Password</button>
                    {% endif %}
                </div>
                
                <div id="password-form" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 4px;">
                    <div class="form-group">
                        <label for="new_password">New Password (min 8 chars)</label>
                        <input type="password" id="new_password" placeholder="Enter new password">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="savePassword()">Save Password</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Passkeys</label>
                <ul class="passkey-list">
                    {% for cred in credentials %}
                    <li>üîë Passkey added on {{ cred.created_at }}</li>
                    {% endfor %}
                </ul>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addPasskey()">‚ûï Add New Passkey</button>
            </div>

            <div class="form-group">
                <label>Two-Factor Authentication (2FA)</label>
                <div class="2fa-actions">
                    {% if has_2fa %}
                        <p class="status-text">‚úÖ 2FA is enabled</p>
                        <button type="button" class="btn btn-danger btn-sm" onclick="disable2FA()">Disable 2FA</button>
                    {% else %}
                        <p class="status-text warning">‚ö†Ô∏è 2FA is not enabled</p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="setup2FA()">Setup 2FA</button>
                    {% endif %}
                </div>
                
                <div id="2fa-setup" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 4px; text-align: center;">
                    <p>Scan this QR code with your authenticator app:</p>
                    <img id="qr-code-img" src="" alt="QR Code" style="background: white; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <p>Then enter the 6-digit code below:</p>
                    <input type="text" id="setup_totp_code" placeholder="123456" style="width: 150px; text-align: center; margin-bottom: 10px;">
                    <button type="button" class="btn btn-primary btn-block" onclick="verifySetup2FA()">Verify & Enable</button>
                </div>
            </div>

            <div class="form-group">
                <label>Recovery Codes</label>
                <div class="recovery-actions">
                    <p class="status-text">
                        {% if recovery_codes_count > 0 %}
                        ‚úÖ {{ recovery_codes_count }} unused codes remaining
                        {% else %}
                        ‚ö†Ô∏è No recovery codes generated
                        {% endif %}
                    </p>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="generateRecoveryCodes()">üîÑ Generate New Codes</button>
                </div>
                <div id="recovery-codes-display" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 4px;">
                    <p class="warning" style="margin-bottom: 0.5rem;">‚ö†Ô∏è Save these codes somewhere safe. They will not be shown again.</p>
                    <div id="codes-list" style="font-family: monospace; font-size: 1.1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"></div>
                </div>
            </div>
        </div>

        <h3>Cloudflare Settings</h3>
        
        <div class="form-group">
            <label for="CF_API_TOKEN">Cloudflare API Token</label>
            <input type="password" id="CF_API_TOKEN" name="CF_API_TOKEN" required 
                   value="{{ settings.get('CF_API_TOKEN', '') }}" autocomplete="off">
        </div>
        
        <div class="form-group">
            <label for="CF_ZONE_ID">Cloudflare Zone ID</label>
            <input type="text" id="CF_ZONE_ID" name="CF_ZONE_ID" required 
                   value="{{ settings.get('CF_ZONE_ID', '') }}">
        </div>
        
        <div class="form-group">
            <label for="DOMAIN_ROOT">Domain Root</label>
            <input type="text" id="DOMAIN_ROOT" name="DOMAIN_ROOT" required 
                   value="{{ settings.get('DOMAIN_ROOT', '') }}"
                   placeholder="example.com">
        </div>
        
        <div class="form-group">
            <label for="ORIGIN_RULE_NAME">Origin Rule Name</label>
            <input type="text" id="ORIGIN_RULE_NAME" name="ORIGIN_RULE_NAME" required 
                   value="{{ settings.get('ORIGIN_RULE_NAME', '') }}"
                   placeholder="Service Rotation">
        </div>
        
        <h3>Traefik / Redis Settings</h3>
        
        <div class="form-group">
            <label for="REDIS_HOST">Redis Host</label>
            <input type="text" id="REDIS_HOST" name="REDIS_HOST" required 
                   value="{{ settings.get('REDIS_HOST', '') }}"
                   placeholder="127.0.0.1">
        </div>
        
        <div class="form-group">
            <label for="REDIS_PORT">Redis Port</label>
            <input type="number" id="REDIS_PORT" name="REDIS_PORT" required 
                   value="{{ settings.get('REDIS_PORT', '6379') }}">
        </div>
        
        <div class="form-group">
            <label for="REDIS_PASS">Redis Password (optional)</label>
            <input type="password" id="REDIS_PASS" name="REDIS_PASS" 
                   value="{{ settings.get('REDIS_PASS', '') }}" autocomplete="off">
        </div>
        
        <h3>Home Assistant Settings</h3>
        
        <div class="form-group">
            <label for="HASS_ENABLED">Enable Home Assistant Integration</label>
            <select id="HASS_ENABLED" name="HASS_ENABLED" onchange="toggleHomeAssistantSettings()">
                <option value="0" {% if settings.get('HASS_ENABLED', '0') == '0' %}selected{% endif %}>Disabled</option>
                <option value="1" {% if settings.get('HASS_ENABLED', '0') == '1' %}selected{% endif %}>Enabled</option>
            </select>
        </div>
        
        <div id="hass-settings" style="{% if settings.get('HASS_ENABLED', '1') == '0' %}display: none;{% else %}display: grid;{% endif %}">
            <div class="form-group">
                <label for="HASS_URL">Home Assistant URL</label>
                <input type="text" id="HASS_URL" name="HASS_URL" 
                       value="{{ settings.get('HASS_URL', '') }}"
                       placeholder="http://homeassistant.local:8123">
            </div>
            
            <div class="form-group">
                <label for="HASS_TOKEN">Home Assistant Token</label>
                <input type="password" id="HASS_TOKEN" name="HASS_TOKEN" 
                       value="{{ settings.get('HASS_TOKEN', '') }}" autocomplete="off">
            </div>
        </div>
        
        <h3>Firewall Settings</h3>
        
        <div class="form-group">
            <label for="FIREWALL_TYPE">Firewall Controller Type</label>
            <select id="FIREWALL_TYPE" name="FIREWALL_TYPE" onchange="toggleFirewallSettings()">
                <option value="none" {% if settings.get('FIREWALL_TYPE', 'unifi') == 'none' %}selected{% endif %}>None</option>
                <option value="unifi" {% if settings.get('FIREWALL_TYPE', 'unifi') == 'unifi' %}selected{% endif %}>UniFi</option>
            </select>
        </div>
        
        <div id="unifi-settings" style="{% if settings.get('FIREWALL_TYPE', 'unifi') == 'none' %}display: none;{% else %}display: grid;{% endif %}">
            <div class="form-group">
                <label for="UNIFI_HOST">UniFi Host</label>
                <input type="text" id="UNIFI_HOST" name="UNIFI_HOST" 
                       value="{{ settings.get('UNIFI_HOST', '') }}"
                       placeholder="192.168.1.1">
            </div>
            
            <div class="form-group">
                <label for="UNIFI_USER">UniFi Username</label>
                <input type="text" id="UNIFI_USER" name="UNIFI_USER" 
                       value="{{ settings.get('UNIFI_USER', '') }}">
            </div>
            
            <div class="form-group">
                <label for="UNIFI_PASS">UniFi Password</label>
                <input type="password" id="UNIFI_PASS" name="UNIFI_PASS" 
                       value="{{ settings.get('UNIFI_PASS', '') }}" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label for="UNIFI_RULE_NAME">UniFi Port Forward Rule Name</label>
                <input type="text" id="UNIFI_RULE_NAME" name="UNIFI_RULE_NAME" 
                       value="{{ settings.get('UNIFI_RULE_NAME', '') }}"
                       placeholder="External">
            </div>

            <div class="form-group">
                <label for="UNIFI_IP_GROUP_NAME">Allowed IPs List (Address Group)</label>
                <input type="text" id="UNIFI_IP_GROUP_NAME" name="UNIFI_IP_GROUP_NAME" 
                       value="{{ settings.get('UNIFI_IP_GROUP_NAME', '') }}"
                       placeholder="VLAN 50 Allowed IPs">
            </div>

            <div class="form-group">
                <label for="UNIFI_PORT_GROUP_NAME">Allowed Ports List (Port Group)</label>
                <input type="text" id="UNIFI_PORT_GROUP_NAME" name="UNIFI_PORT_GROUP_NAME" 
                       value="{{ settings.get('UNIFI_PORT_GROUP_NAME', '') }}"
                       placeholder="VLAN 50 Allowed Ports">
            </div>

            <div class="form-group">
                <label for="TRAEFIK_LAN_CIDR">Traefik LAN CIDR (Excluded from IP List)</label>
                <input type="text" id="TRAEFIK_LAN_CIDR" name="TRAEFIK_LAN_CIDR" 
                       value="{{ settings.get('TRAEFIK_LAN_CIDR', '') }}"
                       placeholder="192.168.50.0/24">
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-secondary" onclick="syncFirewall()">üîÑ Sync Firewall Groups Now</button>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
            <a href="/" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// WebAuthn Helpers
function arrayBufferToBase64(buffer) {
    const binary = Array.from(new Uint8Array(buffer), byte => String.fromCharCode(byte)).join('');
    return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function base64ToArrayBuffer(base64) {
    let standardBase64 = base64.replace(/-/g, '+').replace(/_/g, '/');
    while (standardBase64.length % 4 !== 0) standardBase64 += '=';
    const binary = atob(standardBase64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
}

function togglePasswordForm() {
    const form = document.getElementById('password-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function savePassword() {
    const password = document.getElementById('new_password').value;
    if (password.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
    }
    
    try {
        const response = await fetch('/auth/password/change', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: password})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('Password updated successfully');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Error updating password: ' + e.message);
    }
}

async function addPasskey() {
    try {
        // 1. Get options
        const optionsResponse = await fetch('/auth/passkey/add/begin', {
            method: 'POST'
        });
        
        if (!optionsResponse.ok) throw new Error('Failed to start registration');
        const options = await optionsResponse.json();
        
        // 2. Convert buffers
        options.challenge = base64ToArrayBuffer(options.challenge);
        options.user.id = base64ToArrayBuffer(options.user.id);
        if (options.excludeCredentials) {
            options.excludeCredentials = options.excludeCredentials.map(c => ({
                ...c,
                id: base64ToArrayBuffer(c.id)
            }));
        }
        
        // 3. Create credential
        const credential = await navigator.credentials.create({
            publicKey: options
        });
        
        // 4. Prepare response
        const credentialData = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            response: {
                attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
            },
            type: credential.type
        };
        
        // 5. Send to server
        const verifyResponse = await fetch('/auth/passkey/add/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({credential: credentialData})
        });
        
        const result = await verifyResponse.json();
        if (verifyResponse.ok) {
            alert('Passkey added successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (e) {
        console.error(e);
        alert('Failed to add passkey: ' + e.message);
    }
}

async function setup2FA() {
    try {
        const response = await fetch('/auth/2fa/setup/begin', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('qr-code-img').src = data.qr_code;
            document.getElementById('2fa-setup').style.display = 'block';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Failed to start 2FA setup: ' + e.message);
    }
}

async function verifySetup2FA() {
    const code = document.getElementById('setup_totp_code').value;
    if (!code) return;
    
    try {
        const response = await fetch('/auth/2fa/setup/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code: code})
        });
        
        const data = await response.json();
        if (response.ok) {
            alert('2FA Enabled Successfully!');
            location.reload();
        } else {
            alert('Verification failed: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function disable2FA() {
    if (!confirm('Are you sure you want to disable 2FA? This will reduce your account security.')) return;
    
    try {
        const response = await fetch('/auth/2fa/disable', { method: 'POST' });
        if (response.ok) {
            location.reload();
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function generateRecoveryCodes() {
    if (!confirm('Generating new codes will invalidate any existing recovery codes. Continue?')) return;
    
    try {
        const response = await fetch('/auth/2fa/recovery-codes/generate', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            const list = document.getElementById('codes-list');
            list.innerHTML = '';
            data.codes.forEach(code => {
                const el = document.createElement('div');
                el.textContent = code;
                list.appendChild(el);
            });
            document.getElementById('recovery-codes-display').style.display = 'block';
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function toggleHomeAssistantSettings() {
    const enabled = document.getElementById('HASS_ENABLED').value === '1';
    const hassSettings = document.getElementById('hass-settings');
    
    if (enabled) {
        hassSettings.style.display = 'grid';
    } else {
        hassSettings.style.display = 'none';
    }
}

function toggleFirewallSettings() {
    const type = document.getElementById('FIREWALL_TYPE').value;
    const unifiSettings = document.getElementById('unifi-settings');
    
    if (type === 'unifi') {
        unifiSettings.style.display = 'grid';
    } else {
        unifiSettings.style.display = 'none';
    }
}

function syncFirewall() {
    if(confirm('Force sync UniFi firewall groups?')) {
        fetch('/api/sync-firewall', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if(data.error) alert('Error: ' + data.error);
                else alert('Sync triggered. Check logs for details.');
            });
    }
}
</script>

<style>
.security-section {
    background: var(--bg-card);
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 2rem;
}
</style>
{% endblock %}
