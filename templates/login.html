<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Traefik Route Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-header">
            <h1>üö¶ Traefik Route Control</h1>
            <p>Secure access with passkey authentication</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% if is_setup %}
        <div class="setup-message">
            <h2>Welcome! Setup Required</h2>
            {% if setup_expired %}
            <p class="warning">‚ö†Ô∏è The 5-minute setup window has expired. Please restart the application to create an admin account.</p>
            {% else %}
            <p>Create your admin account to get started.</p>
            {% if in_setup_window %}
            <p class="info">üí° You have 5 minutes from startup to complete setup.</p>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
        
        <div class="login-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required 
                       placeholder="Enter your username" autocomplete="username">
            </div>
            
            {% if is_setup %}
            {% if not setup_expired %}
            <button type="button" class="btn btn-primary btn-block" onclick="registerPasskey()">
                üîë Create Account with Passkey
            </button>
            {% endif %}
            {% else %}
            <button type="button" class="btn btn-primary btn-block" onclick="authenticatePasskey()">
                üîê Sign In with Passkey
            </button>
            {% endif %}
        </div>
        
        <div class="login-info">
            <p><strong>What is a passkey?</strong></p>
            <p>A passkey is a secure, passwordless login method that uses your device's biometric authentication (fingerprint, face recognition) or PIN.</p>
        </div>
    </div>
    
    <script>
        const isSetup = {{ 'true' if is_setup else 'false' }};
        
        // Helper to convert ArrayBuffer to Base64URL (URL-safe)
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            const chars = [];
            for (let i = 0; i < bytes.length; i++) {
                chars.push(String.fromCharCode(bytes[i]));
            }
            const binary = chars.join('');
            // Convert to base64 and make it URL-safe
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        // Helper to convert Base64URL to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            // Convert from URL-safe base64 to standard base64
            let standardBase64 = base64
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            // Add padding if necessary
            while (standardBase64.length % 4 !== 0) {
                standardBase64 += '=';
            }
            const binary = atob(standardBase64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        // Register a new passkey
        async function registerPasskey() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            try {
                // Request registration options from server
                const optionsResponse = await fetch('/auth/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: username})
                });
                
                if (!optionsResponse.ok) {
                    const error = await optionsResponse.json();
                    alert('Error: ' + (error.error || 'Failed to start registration'));
                    return;
                }
                
                const options = await optionsResponse.json();
                
                // Convert challenge from base64
                options.challenge = base64ToArrayBuffer(options.challenge);
                options.user.id = base64ToArrayBuffer(options.user.id);
                
                // Create credential
                const credential = await navigator.credentials.create({
                    publicKey: options
                });
                
                // Prepare credential for server
                const credentialData = {
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
                    },
                    type: credential.type
                };
                
                // Send to server
                const verifyResponse = await fetch('/auth/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: username,
                        credential: credentialData
                    })
                });
                
                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    alert('Error: ' + (error.error || 'Registration failed'));
                    return;
                }
                
                alert('Account created successfully! Redirecting...');
                window.location.href = '/';
                
            } catch (error) {
                console.error('Registration error:', error);
                alert('Failed to register passkey: ' + error.message);
            }
        }
        
        // Authenticate with existing passkey
        async function authenticatePasskey() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            try {
                // Request authentication options from server
                const optionsResponse = await fetch('/auth/login/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: username})
                });
                
                if (!optionsResponse.ok) {
                    const error = await optionsResponse.json();
                    alert('Error: ' + (error.error || 'Failed to start authentication'));
                    return;
                }
                
                const options = await optionsResponse.json();
                
                // Convert challenge and credential IDs from base64
                options.challenge = base64ToArrayBuffer(options.challenge);
                if (options.allowCredentials) {
                    options.allowCredentials = options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64ToArrayBuffer(cred.id)
                    }));
                }
                
                // Get credential
                const credential = await navigator.credentials.get({
                    publicKey: options
                });
                
                // Prepare credential for server
                const credentialData = {
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                        signature: arrayBufferToBase64(credential.response.signature),
                        userHandle: credential.response.userHandle ? arrayBufferToBase64(credential.response.userHandle) : null
                    },
                    type: credential.type
                };
                
                // Send to server
                const verifyResponse = await fetch('/auth/login/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: username,
                        credential: credentialData
                    })
                });
                
                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    alert('Error: ' + (error.error || 'Authentication failed'));
                    return;
                }
                
                window.location.href = '/';
                
            } catch (error) {
                console.error('Authentication error:', error);
                alert('Failed to authenticate: ' + error.message);
            }
        }
        
        // Allow Enter key to trigger login/register
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (isSetup) {
                    registerPasskey();
                } else {
                    authenticatePasskey();
                }
            }
        });
    </script>
</body>
</html>
