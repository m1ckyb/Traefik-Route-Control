<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Traefik Route Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1.1">
    <script>
        // Immediately try to apply the theme to prevent FOUC
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-header">
            <h1>üö¶ Traefik Route Control</h1>
            <p>Secure access with passkey authentication</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        {% for category, message in messages %}
                            showToast("{{ message }}", "{{ category }}");
                        {% endfor %}
                    });
                </script>
            {% endif %}
        {% endwith %}
        
        {% if is_setup %}
        <div class="setup-message">
            <h2>Welcome! Setup Required</h2>
            {% if setup_expired %}
            <p class="warning">‚ö†Ô∏è The 5-minute setup window has expired. Please restart the application to create an admin account.</p>
            {% else %}
            <p>Create your admin account to get started.</p>
            {% if in_setup_window %}
            <p class="info">üí° You have 5 minutes from startup to complete setup.</p>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
        
        <div class="login-form">
            {% if not is_setup %}
            <div class="auth-tabs">
                <button type="button" class="auth-tab active" onclick="switchAuth('passkey')" id="tab-passkey">Passkey</button>
                <button type="button" class="auth-tab" onclick="switchAuth('password')" id="tab-password">Password</button>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required 
                       placeholder="Enter your username" autocomplete="username">
            </div>
            
            <div class="form-group" id="password-group" style="display: none;">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" 
                       placeholder="Enter your password" autocomplete="current-password">
            </div>

            <div class="form-group" id="totp-group" style="display: none;">
                <label for="totp_code">Two-Factor Code / Recovery Code</label>
                <input type="text" id="totp_code" name="totp_code" 
                       placeholder="Enter 6-digit code or recovery code" autocomplete="one-time-code" inputmode="text">
                <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">Lost your device? Enter a recovery code above.</p>
            </div>
            
            {% if is_setup %}
            {% if not setup_expired %}
            <button type="button" class="btn btn-primary btn-block" onclick="registerPasskey()">
                üîë Create Account with Passkey
            </button>
            {% endif %}
            {% else %}
            <button type="button" id="btn-passkey" class="btn btn-primary btn-block" onclick="authenticatePasskey()">
                üîê Sign In with Passkey
            </button>
            <button type="button" id="btn-password" class="btn btn-primary btn-block" onclick="authenticatePassword()" style="display: none;">
                üîë Sign In with Password
            </button>
            <button type="button" id="btn-totp" class="btn btn-primary btn-block" onclick="verify2FA()" style="display: none;">
                üîê Verify Code
            </button>
            {% endif %}
        </div>
        
        <div class="login-info">
            <p><strong>What is a passkey?</strong></p>
            <p>A passkey is a secure, passwordless login method that uses your device's biometric authentication (fingerprint, face recognition) or PIN.</p>
        </div>
    </div>
    
    <div id="toast-container"></div>
    <script>
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let icon = '‚ÑπÔ∏è';
        if (type === 'success') icon = '‚úÖ';
        if (type === 'error') icon = '‚ùå';
        if (type === 'warning') icon = '‚ö†Ô∏è';
        
        toast.innerHTML = `
            <div class="toast-content">
                <span>${icon}</span>
                <span>${message}</span>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            <div class="toast-progress"></div>
        `;
        
        container.prepend(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('closing');
            toast.addEventListener('animationend', () => {
                if (toast.parentElement) toast.remove();
            });
        }, 5000);
    }
    </script>
    
    <script>
        const isSetup = {{ 'true' if is_setup else 'false' }};
        let currentAuthMode = 'passkey';
        
        // Helper to convert ArrayBuffer to Base64URL (URL-safe)
        function arrayBufferToBase64(buffer) {
            const binary = Array.from(new Uint8Array(buffer), byte => String.fromCharCode(byte)).join('');
            // Convert to base64 and make it URL-safe
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        // Helper to convert Base64URL to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            // Convert from URL-safe base64 to standard base64
            let standardBase64 = base64
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            // Add padding if necessary
            while (standardBase64.length % 4 !== 0) {
                standardBase64 += '=';
            }
            const binary = atob(standardBase64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function switchAuth(mode) {
            currentAuthMode = mode;
            
            // Update tabs
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + mode).classList.add('active');
            
            // Update inputs and buttons
            if (mode === 'password') {
                document.getElementById('password-group').style.display = 'block';
                document.getElementById('btn-password').style.display = 'block';
                document.getElementById('btn-passkey').style.display = 'none';
                document.getElementById('totp-group').style.display = 'none';
                document.getElementById('btn-totp').style.display = 'none';
            } else {
                document.getElementById('password-group').style.display = 'none';
                document.getElementById('btn-password').style.display = 'none';
                document.getElementById('btn-passkey').style.display = 'block';
            }
        }

        // Register a new passkey
        async function registerPasskey() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showToast('Please enter a username', 'warning');
                return;
            }
            
            try {
                // Request registration options from server
                const optionsResponse = await fetch('/auth/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: username})
                });
                
                if (!optionsResponse.ok) {
                    const error = await optionsResponse.json();
                    showToast('Error: ' + (error.error || 'Failed to start registration'), 'error');
                    return;
                }
                
                const options = await optionsResponse.json();
                
                // Convert challenge from base64
                options.challenge = base64ToArrayBuffer(options.challenge);
                options.user.id = base64ToArrayBuffer(options.user.id);
                
                // Create credential
                const credential = await navigator.credentials.create({
                    publicKey: options
                });
                
                // Prepare credential for server
                const credentialData = {
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
                    },
                    type: credential.type
                };
                
                // Send to server
                const verifyResponse = await fetch('/auth/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: username,
                        credential: credentialData
                    })
                });
                
                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    showToast('Error: ' + (error.error || 'Registration failed'), 'error');
                    return;
                }
                
                showToast('Account created successfully! Redirecting...', 'success');
                window.location.href = '/';
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Failed to register passkey: ' + error.message, 'error');
            }
        }
        
        // Authenticate with existing passkey
        async function authenticatePasskey() {
            const username = document.getElementById('username').value.trim();
            
            if (!username) {
                showToast('Please enter a username', 'warning');
                return;
            }
            
            try {
                // Request authentication options from server
                const optionsResponse = await fetch('/auth/login/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: username})
                });
                
                if (!optionsResponse.ok) {
                    const error = await optionsResponse.json();
                    showToast('Error: ' + (error.error || 'Failed to start authentication'), 'error');
                    return;
                }
                
                const options = await optionsResponse.json();
                
                // Convert challenge and credential IDs from base64
                options.challenge = base64ToArrayBuffer(options.challenge);
                if (options.allowCredentials) {
                    options.allowCredentials = options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64ToArrayBuffer(cred.id)
                    }));
                }
                
                // Get credential
                const credential = await navigator.credentials.get({
                    publicKey: options
                });
                
                // Prepare credential for server
                const credentialData = {
                    id: credential.id,
                    rawId: arrayBufferToBase64(credential.rawId),
                    response: {
                        authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
                        clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                        signature: arrayBufferToBase64(credential.response.signature),
                        userHandle: credential.response.userHandle ? arrayBufferToBase64(credential.response.userHandle) : null
                    },
                    type: credential.type
                };
                
                // Send to server
                const verifyResponse = await fetch('/auth/login/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: username,
                        credential: credentialData
                    })
                });
                
                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    showToast('Error: ' + (error.error || 'Authentication failed'), 'error');
                    return;
                }
                
                window.location.href = '/';
                
            } catch (error) {
                console.error('Authentication error:', error);
                showToast('Failed to authenticate: ' + error.message, 'error');
            }
        }
        
        // Authenticate with password
        async function authenticatePassword() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showToast('Please enter username and password', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/auth/login/password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    showToast(data.error || 'Authentication failed', 'error');
                    return;
                }
                
                if (data.success) {
                    if (data.setup_2fa) {
                        showToast("Login successful. Please set up 2FA in Settings.", 'success');
                        window.location.href = '/settings';
                    } else {
                        window.location.href = '/';
                    }
                } else if (data.require_2fa) {
                    // Switch to 2FA input
                    show2FAInput();
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Failed to login: ' + error.message, 'error');
            }
        }
        
        function show2FAInput() {
            document.getElementById('username').parentElement.style.display = 'none';
            document.getElementById('password-group').style.display = 'none';
            document.getElementById('btn-password').style.display = 'none';
            document.getElementById('tab-passkey').parentElement.style.display = 'none';
            
            document.getElementById('totp-group').style.display = 'block';
            document.getElementById('btn-totp').style.display = 'block';
            document.getElementById('totp_code').focus();
        }

        async function verify2FA() {
            const code = document.getElementById('totp_code').value.trim();
            if (!code) return;

            try {
                const response = await fetch('/auth/login/2fa', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    showToast(data.error || 'Verification failed', 'error');
                    return;
                }
                
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('2FA error:', error);
                showToast('Failed to verify code', 'error');
            }
        }

        // Allow Enter key to trigger login/register
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (isSetup) {
                    registerPasskey();
                } else {
                    if (currentAuthMode === 'password') {
                        document.getElementById('password').focus();
                    } else {
                        authenticatePasskey();
                    }
                }
            }
        });
        
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticatePassword();
            }
        });

        document.getElementById('totp_code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verify2FA();
            }
        });
    </script>
    
    <style>
    .auth-tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }
    .auth-tab {
        flex: 1;
        background: none;
        border: none;
        padding: 0.75rem;
        color: var(--text-dim);
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    .auth-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        font-weight: bold;
    }
    </style>
</body>
</html>
