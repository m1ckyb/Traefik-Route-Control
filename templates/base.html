<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Traefik Route Control{% endblock %}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üö¶</text></svg>">
    <script>
        // Immediately try to apply the theme to prevent FOUC
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();

        // Make the theme toggling function globally available
        window.toggleTheme = function(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        };
    </script>
    <style>
        /* Light Theme (Default) */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --secondary: #475569;
            --bg: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #e2e8f0;
            --text: #0f172a;
            --text-dim: #64748b;
            --border: #cbd5e1;
        }

        /* Dark Theme (Blue) */
        html.dark-mode {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --secondary: #64748b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --border: #334155;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1.1">

</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>üö¶ Traefik Route Control</h1>
            <div class="nav-right">
                <div class="nav-status">
                    <span class="status-label">Firewall:</span>
                    <span class="status-badge" id="nav-firewall-status">
                        <span class="loading">Checking...</span>
                    </span>
                </div>
                <div class="nav-links">
                    <a href="/">Services</a>
                    <a href="/settings">Settings</a>
                    <a href="/logout">Logout</a>
                </div>
            </div>
        </div>
    </nav>
    
    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        {% for category, message in messages %}
                            showToast("{{ message }}", "{{ category }}");
                        {% endfor %}
                    });
                </script>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="container">
            <a href="https://github.com/m1ckyb/Traefik-Route-Control" class="footer-link" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                <span>Traefik Route Control</span>
            </a>
            <span>v{{ version }}</span>
        </div>
    </footer>
    
    <div id="toast-container"></div>
    <script>
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let icon = '‚ÑπÔ∏è';
        if (type === 'success') icon = '‚úÖ';
        if (type === 'error') icon = '‚ùå';
        if (type === 'warning') icon = '‚ö†Ô∏è';
        
        toast.innerHTML = `
            <div class="toast-content">
                <span>${icon}</span>
                <span class="toast-message"></span>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            <div class="toast-progress"></div>
        `;
        toast.querySelector('.toast-message').textContent = message;
        
        container.prepend(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('closing');
            toast.addEventListener('animationend', () => {
                if (toast.parentElement) toast.remove();
            });
        }, 5000);
    }
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    // Global function to refresh firewall status in the UI
    window.refreshFirewallStatus = function() {
        const navFirewallStatus = document.getElementById('nav-firewall-status');
        if (!navFirewallStatus) return;

        fetch('/api/firewall-status')
            .then(r => r.json())
            .then(data => {
                let statusText = data.status;
                let statusClass = `status-badge status-${data.status.toLowerCase()}`;
                
                // If firewall is open and port is available, show the port
                if (data.status === 'OPEN' && data.port != null) {
                    statusText = data.port;
                } else if (data.status === 'CLOSED') {
                    statusText = 'Closed';
                }
                
                navFirewallStatus.innerHTML = statusText;
                navFirewallStatus.className = statusClass;

                // Disable/Enable dashboard buttons if they exist
                const checkHealthBtn = document.getElementById('check-health-btn');
                const rotatePortBtn = document.getElementById('rotate-port-btn');
                if (checkHealthBtn && rotatePortBtn) {
                    if (data.status === 'CLOSED') {
                        checkHealthBtn.disabled = true;
                        checkHealthBtn.title = 'Firewall is closed';
                        rotatePortBtn.disabled = true;
                        rotatePortBtn.title = 'Firewall is closed';
                    } else {
                        checkHealthBtn.disabled = false;
                        checkHealthBtn.title = '';
                        rotatePortBtn.disabled = false;
                        rotatePortBtn.title = '';
                    }
                }
            })
            .catch(err => {
                navFirewallStatus.innerHTML = 'ERROR';
                navFirewallStatus.className = 'status-badge status-unknown';
            });
    };

    // Load firewall status on initial load
    document.addEventListener('DOMContentLoaded', refreshFirewallStatus);
    </script>
</body>
</html>
